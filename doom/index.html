<!doctype html>

<!-- copied from https://raw.githubusercontent.com/mdn/webassembly-examples/master/understanding-text-format/logger2.html (CC0) -->

<html>

  <head>
    <meta charset="utf-8">
    <title>DooM</title>
  </head>

  <body>
    <script>
      var memory = new WebAssembly.Memory({ initial : 86 });

      function consoleLogString(offset, length) {
        var bytes = new Uint8Array(memory.buffer, offset, length);
        var string = new TextDecoder('utf8').decode(bytes);
        console.log(string);
      }

      function  GetTimeOfDay(ptr) {
        var timeval = new Uint32Array(memory.buffer, ptr, 2);
        // TODO: maybe wait for animation frame?
        let t = new Date();
        timeval[0] = t.getSeconds();
        timeval[1] = t.getMilliseconds() * 1000 // as usec YOLO;
      }

      var importObject = {
        js: {
          console_log: consoleLogString,
          js_timeofday: GetTimeOfDay,
        },
        env: {
          memory: memory
        }
      };

      WebAssembly.instantiateStreaming(fetch('target/wasm32-unknown-unknown/debug/doom.wasm'), importObject)
      .then(obj => {
        obj.instance.exports.main();
      });
    </script>
  </body>

</html>
